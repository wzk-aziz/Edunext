<!-- Loading State -->
<div class="loading-overlay" *ngIf="loading">
  <div class="spinner"></div>
  <p>Loading session data...</p>
</div>

<!-- Error State -->
<div class="error-overlay" *ngIf="error">
  <div class="error-message">
    <i class="fas fa-exclamation-circle"></i>
    <h3>Data Loading Error</h3>
    <p>{{ error }}</p>
    
    <!--<button class="primary-btn" (click)="loadSessionDetails()">Try Again</button>    -->
    
    <button class="secondary-btn" routerLink="/teacher/virtual-classrooms">Back to Sessions</button>
  </div>
</div>

<!-- LIVE SESSION VIEW (Main View) -->
<div class="live-session-container" *ngIf="!loading && !error">
  <!-- Session Header -->
  <header class="session-header">
    <div class="session-info">
      <h1>{{ session?.titleSession }}</h1>
      <p>{{ getDurationDisplay() }} Â· {{ formatDate(session?.startTime) }}</p>
    </div>
    <div class="session-actions">
      <!-- Video controls -->
      <button class="control-btn" [class.disabled]="!cameraEnabled" (click)="toggleCamera()">
        <i class="fas" [ngClass]="cameraEnabled ? 'fa-video' : 'fa-video-slash'"></i>
      </button>
      
      <button class="control-btn" [class.disabled]="!micEnabled" (click)="toggleMic()">
        <i class="fas" [ngClass]="micEnabled ? 'fa-microphone' : 'fa-microphone-slash'"></i>
      </button>
      
      <button class="control-btn" [class.active]="screenSharing" (click)="toggleScreenShare()">
        <i class="fas fa-desktop"></i>
      </button>
      
      <!-- Teacher-specific controls -->
      <button class="control-btn" [class.active]="currentTab === 'analytics'" (click)="toggleAnalyticsPane()">
        <i class="fas fa-chart-bar"></i>
      </button>
      
      <button class="leave-btn" routerLink="/teacher/virtual-classrooms">
        <i class="fas fa-arrow-left"></i> Back to Sessions
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Video Area -->
    <div class="video-area" [ngClass]="{'with-sidebar': showAnalytics}">
      <!-- Main Video Display -->
      <div class="video-container main-video">
        <div class="video-player">
          <!-- Video element with controls -->
          <video controls autoplay class="live-video-player" *ngIf="videoAvailable">
            <source [src]="videoSource" type="video/mp4">
            Your browser does not support HTML5 video.
          </video>
        
          <!-- Fallback when no video available -->
          <div class="video-placeholder" *ngIf="!videoAvailable">
            <i class="fas fa-video-slash"></i>
            <p>Recording not available or ended</p>
            <button class="upload-btn" (click)="uploadRecording()">
              <i class="fas fa-cloud-upload-alt"></i> Upload Recording
            </button>
          </div>
          
          <div class="video-controls-overlay">
            <div class="video-title">
              <h3>{{ session?.titleSession }}</h3>
              <p>{{ formatDate(session?.startTime) }}</p>
            </div>
            <div class="video-actions">
              <button class="video-action-btn" (click)="toggleMic()">
                <i class="fas" [ngClass]="micEnabled ? 'fa-microphone' : 'fa-microphone-slash'"></i>
              </button>
              <button class="video-action-btn" (click)="toggleCamera()">
                <i class="fas" [ngClass]="cameraEnabled ? 'fa-video' : 'fa-video-slash'"></i>
              </button>
              <button class="video-action-btn" (click)="toggleScreenShare()">
                <i class="fas fa-desktop"></i>
              </button>
              <button class="video-action-btn" (click)="toggleParticipantsPanel()">
                <i class="fas fa-users"></i>
              </button>
              <button class="video-action-btn exit" routerLink="/teacher/virtual-classrooms">
                <i class="fas fa-phone-slash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Teacher Preview Video -->
      <div class="video-container teacher-video">
        <div class="video-frame">
          <!-- Show screen share when active -->
          <video #screenVideo 
                *ngIf="screenSharing && screenStream" 
                [srcObject]="screenStream" 
                autoplay 
                class="screen-share-video">
          </video>
          
          <!-- Show user webcam when not screen sharing but camera is enabled -->
          <video #userVideo 
                *ngIf="!screenSharing && cameraEnabled && userStream" 
                [srcObject]="userStream" 
                autoplay 
                muted
                class="user-video">
          </video>
          
          <!-- Show user placeholder when camera is off -->
          <div class="user-video-placeholder" *ngIf="(!cameraEnabled || !userStream) && !screenSharing">
            <i class="fas fa-user-tie"></i>
          </div>
          
          <!-- Video label -->
          <div class="video-label" [class.sharing]="screenSharing">
            <span>{{ screenSharing ? 'Your Screen' : 'You (Teacher)' }}</span>
            <i class="fas" [ngClass]="micEnabled ? 'fa-microphone' : 'fa-microphone-slash'"></i>
            <i *ngIf="screenSharing" class="fas fa-desktop screen-share-icon"></i>
          </div>
        </div>
      </div>
      
      <!-- Students Grid (conditionally visible) -->
      <div class="students-video-grid" *ngIf="showParticipants">
        <div class="students-header">
          <h3>Students ({{ attendanceRate }}% attending)</h3>
          <button class="close-btn" (click)="toggleParticipantsPanel()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="participants-grid">
          <div class="participant-video" *ngFor="let student of students.slice(0, 6)">
            <div class="video-frame">
              <div class="user-video-placeholder">
                <div class="student-avatar">{{ student.name.charAt(0) }}</div>
              </div>
              <div class="video-label">
                <span>{{ student.name }}</span>
                <i class="fas fa-microphone-slash"></i>
                <i *ngIf="student.handRaised" class="fas fa-hand-paper raise-hand-icon"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
      <div class="chat-header">
        <h3>Session Chat</h3>
        <div class="chat-controls">
          <span class="online-indicator">
            <span class="dot"></span> {{ students.length }} students
          </span>
          <button class="chat-action-btn" (click)="downloadChatLog()">
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>
      
      <div class="messages-container" #messagesContainer>
        <div class="date-divider">
          <span>{{ formatDate(session?.startTime) }}</span>
        </div>
        
        <div class="message" 
             *ngFor="let message of chatMessages" 
             [ngClass]="{
               'teacher-message': message.sender === session?.instructorName,
               'system-message': message.sender === 'System'
             }">
          <div class="message-header">
            <strong [ngClass]="{'instructor': message.sender === session?.instructorName}">
              {{ message.sender }}
              <span *ngIf="message.sender === session?.instructorName">(you)</span>
            </strong>
            <span class="message-time">{{ message.time }}</span>
          </div>
          <div class="message-content">
            {{ message.content }}
          </div>
        </div>
        
        <div class="no-messages" *ngIf="chatMessages.length === 0">
          <i class="fas fa-comments"></i>
          <p>No messages were sent during this session.</p>
        </div>
      </div>
      
      <div class="message-input">
        <input 
          type="text" 
          [(ngModel)]="newMessage" 
          placeholder="Type your message..." 
          (keyup.enter)="sendMessage()"
        >
        <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage.trim()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      
      <!-- Student Questions Section -->
      <div class="questions-section">
        <div class="questions-header">
          <h3>Student Questions</h3>
          <span class="questions-count">{{ studentQuestions.length }} questions</span>
        </div>
        
        <div class="questions-list" *ngIf="studentQuestions.length > 0">
          <div class="question-item" *ngFor="let question of studentQuestions">
            <div class="question-header">
              <div class="student-info">
                <div class="student-avatar">{{ question.student.charAt(0) }}</div>
                <span>{{ question.student }}</span>
              </div>
              <span class="question-time">{{ question.time }}</span>
            </div>
            <div class="question-content">
              {{ question.content }}
            </div>
            <div class="question-answer" *ngIf="question.answered">
              <div class="answer-label">Your Answer:</div>
              <div class="answer-content">{{ question.answer }}</div>
            </div>
            <div class="question-actions" *ngIf="!question.answered">
              <button class="question-action-btn" (click)="answerQuestion(question)">
                <i class="fas fa-reply"></i> Answer
              </button>
            </div>
          </div>
        </div>
        
        <div class="no-questions" *ngIf="studentQuestions.length === 0">
          <i class="fas fa-question-circle"></i>
          <p>No questions were asked during this session.</p>
        </div>
      </div>
    </div>
    
    <!-- Analytics Sidebar (conditionally visible) -->
    <div class="analytics-sidebar" *ngIf="showAnalytics">
      <div class="analytics-header">
        <h3>Session Analytics</h3>
        <button class="close-btn" (click)="toggleAnalyticsPane()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="analytics-content">
        <div class="stats-cards">
          <div class="stat-card">
            <div class="stat-icon students-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
              <h4>{{ session?.enrolledStudents || 0 }}</h4>
              <p>Total Students</p>
              <div class="stat-detail">
                <span>Attendance: {{ attendanceRate }}%</span>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon engagement-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <div class="stat-info">
              <h4>{{ averageEngagement }}%</h4>
              <p>Avg. Engagement</p>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon questions-icon">
              <i class="fas fa-question-circle"></i>
            </div>
            <div class="stat-info">
              <h4>{{ questionsCount }}</h4>
              <p>Questions Asked</p>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon feedback-icon">
              <i class="fas fa-star"></i>
            </div>
            <div class="stat-info">
              <h4>{{ averageRating | number:'1.1-1' }}</h4>
              <p>Average Rating</p>
            </div>
          </div>
        </div>
        
        <div class="analytics-actions">
          <button class="action-btn" (click)="sendFollowUp()">
            <i class="fas fa-paper-plane"></i> Follow-up
          </button>
          <button class="action-btn" (click)="downloadReport()">
            <i class="fas fa-file-download"></i> Report
          </button>
          <button class="action-btn" (click)="showFeedbackModal()">
            <i class="fas fa-comments"></i> Feedback
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Keep all your existing modals -->
<!-- Feedback Modal -->
<div class="feedback-modal-overlay" *ngIf="showFeedbackModal">
  <!-- Existing feedback modal content -->
</div>

<!-- Follow-up Modal -->
<div class="followup-modal-overlay" *ngIf="showFollowupModal">
  <!-- Existing followup modal content -->
</div>
<!-- Session Time Popup -->
<div class="session-time-popup-overlay" *ngIf="showSessionTimePopup">
  <div class="session-time-popup">
    <div class="popup-header">
      <h3><i class="fas fa-clock"></i> Session Information</h3>
      <button class="close-btn" (click)="closeSessionTimePopup()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="popup-content">
      <div class="session-title">{{ session?.title }}</div>
      
      <div class="session-time-info">
        <div class="time-detail">
          <i class="fas fa-calendar-day"></i>
          <span>{{ formatDate(session?.startTime) }}</span>
        </div>
        <div class="time-detail">
          <i class="fas fa-hourglass-half"></i>
          <span>{{ getDurationDisplay() }}</span>
        </div>
        <div class="time-detail" *ngIf="isSessionActive">
          <i class="fas fa-circle pulse-animation"></i>
          <span class="status active">Active Now</span>
        </div>
        <div class="time-detail" *ngIf="isSessionPast && !isSessionActive">
          <i class="fas fa-check-circle"></i>
          <span class="status past">Session Completed</span>
        </div>
        <div class="time-detail" *ngIf="isSessionFuture && !isSessionActive">
          <i class="fas fa-clock"></i>
          <span class="status future">Starts in {{ getTimeUntilSession() }}</span>
        </div>
      </div>
      
      <div class="popup-actions">
        <button *ngIf="isSessionActive" class="primary-btn" (click)="joinLiveSession()">
          <i class="fas fa-video"></i> Join Live Now
        </button>
        
        <button *ngIf="isSessionPast && !isSessionActive" class="primary-btn" (click)="reviewRecording()">
          <i class="fas fa-play-circle"></i> Review Recording
        </button>
        
        <button *ngIf="isSessionFuture && !isSessionActive" class="secondary-btn" (click)="prepareSession()">
          <i class="fas fa-tools"></i> Prepare Session
        </button>
        
        <button class="cancel-btn" (click)="closeSessionTimePopup()">
          <i class="fas fa-arrow-left"></i> Back to Sessions
        </button>
      </div>
    </div>
  </div>
</div>