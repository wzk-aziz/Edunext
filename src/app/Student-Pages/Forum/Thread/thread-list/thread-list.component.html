<div class="threads-container">
  <div class="threads-header">
    <h1>Liste des Threads</h1>
    <p class="subtitle">Partagez vos pensées avec la communauté</p>
  </div>

  <!-- Barre de recherche et filtres -->
  <div class="filters-container">
    <div class="search-bar">
      <i class="fa fa-search"></i>
      <input 
        type="text" 
        placeholder="Rechercher un thread..." 
        [(ngModel)]="searchTerm" 
        (input)="filterThreads()"
      >
    </div>

    <div class="filter-options">
      <div class="dropdown">
        <div class="dropdown-toggle">
          Filtrer par tag
          <i class="fa fa-chevron-down"></i>
        </div>
        <div class="dropdown-menu">
          <div 
            *ngFor="let tag of availableTags" 
            class="dropdown-item" 
            [class.selected]="selectedTags.includes(tag)"
            (click)="addTag(tag)"
          >
            #{{tag}}
          </div>
        </div>
      </div>
      <div class="dropdown">
        <div class="dropdown-toggle">
          Trier par
          <i class="fa fa-chevron-down"></i>
        </div>
        <div class="dropdown-menu">
          <div 
            *ngFor="let option of sortOptions" 
            class="dropdown-item" 
            [class.selected]="selectedSort === option.value"
            (click)="sortThreads(option.value)"
          >
            {{option.label}}
          </div>
        </div>
      </div>

      <!-- Bouton pour créer un nouveau thread -->
      <button class="create-thread-btn" routerLink="/new">
        <i class="fa fa-plus"></i> Nouveau Thread
      </button>
    </div>
  </div>

  <!-- Liste des threads -->
  <div class="threads-list" *ngIf="filteredThreads.length > 0; else noThreads">
    <div class="thread-card" *ngFor="let thread of getCurrentPageThreads()">
      <div class="thread-header">
        <h3 class="thread-title" [routerLink]="['/thread', thread.id]">{{thread.threadTitle}}</h3>
        <div class="thread-actions">
          <button class="action-button edit" title="Modifier">
            <i class="fa fa-edit"></i>
          </button>
          <button class="action-button delete" title="Supprimer" (click)="deleteThread(thread.id!)">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </div>

      <div class="thread-content">
        <p>{{getThreadPreview(thread.threadContent)}}</p>
      </div>

      <!-- Section de tags -->
      <div class="thread-tags">
        <span class="tag" *ngFor="let tag of extractTags(thread.threadContent)" [class]="tag">
          {{tag}}
        </span>
      </div>

      <!-- Affichage des compteurs de réactions (style Facebook) -->
      <div class="reaction-counters" *ngIf="getReactionCount(thread.id || 0, 'LIKE') > 0 || getReactionCount(thread.id || 0, 'LOVE') > 0 || getReactionCount(thread.id || 0, 'HAHA') > 0">
        <div class="reaction-icons">
          <span class="reaction-icon" *ngIf="getReactionCount(thread.id || 0, 'LIKE') > 0">
            <i class="fa fa-thumbs-up" style="color: #4267B2;"></i>
          </span>
          <span class="reaction-icon" *ngIf="getReactionCount(thread.id || 0, 'LOVE') > 0">
            <i class="fa fa-heart" style="color: #E91E63;"></i>
          </span>
          <span class="reaction-icon" *ngIf="getReactionCount(thread.id || 0, 'HAHA') > 0">
            <i class="fa fa-laugh" style="color: #FFC107;"></i>
          </span>
        </div>
        <span class="reaction-count">
          {{ getReactionCount(thread.id || 0, 'LIKE') + getReactionCount(thread.id || 0, 'LOVE') + getReactionCount(thread.id || 0, 'HAHA') }}
        </span>
      </div>

      <!-- Compteur de commentaires -->
      <div class="comment-counter" *ngIf="getReactionCount(thread.id || 0, 'COMMENT') > 0" (click)="toggleCommentBox(thread)">
        {{ getReactionCount(thread.id || 0, 'COMMENT') }} commentaire{{ getReactionCount(thread.id || 0, 'COMMENT') > 1 ? 's' : '' }}
      </div>

      <!-- Barre de réactions multiples (J'aime, J'adore, Haha) -->
      <div class="reaction-bar">
        <div *ngFor="let reactionOption of reactionTypes"
              class="reaction-option"
              [class.active]="hasReacted(thread.id || 0, reactionOption.type)"
              [style.background-color]="hasReacted(thread.id || 0, reactionOption.type) ? reactionOption.color : '#f5f5f5'"
              [style.color]="hasReacted(thread.id || 0, reactionOption.type) ? 'white' : 'inherit'"
              (click)="toggleReaction(thread.id || 0, reactionOption.type)">
          <i class="fa" [ngClass]="reactionOption.icon"></i>
          <span>{{ reactionOption.label }}</span>
          <span class="counter" *ngIf="getReactionCount(thread.id || 0, reactionOption.type) > 0">
            {{ getReactionCount(thread.id || 0, reactionOption.type) }}
          </span>
        </div>
        <button class="comment-toggle-btn" (click)="toggleCommentBox(thread)">
          <i class="fa fa-comment"></i> Comment
        </button>
      </div>

      <!-- Section de commentaires (affichage et ajout) -->
      <div class="comment-section" *ngIf="showCommentBox[thread.id || 0]">
        <!-- Liste des commentaires existants -->
        <div class="existing-comments" *ngIf="getThreadComments(thread).length > 0">
          <h4>Commentaires ({{ getReactionCount(thread.id || 0, 'COMMENT') }})</h4>
          <div class="single-comment"
                *ngFor="let reaction of getThreadComments(thread)">
            <div class="comment-header">
              <div class="comment-avatar">
                <i class="fa fa-user-circle"></i>
              </div>
              <p class="comment-author">{{ reaction.studentEmail }}</p>
            </div>
            <p class="comment-content">{{ reaction.reactionContent }}</p>
            <div class="comment-actions">
              <span class="comment-like">J'aime</span>
              <span class="comment-reply">Répondre</span>
            </div>
          </div>
        </div>
        
        <!-- Formulaire pour ajouter un nouveau commentaire -->
        <div class="comment-form">
          <div class="comment-input-container">
            <div class="comment-avatar">
              <i class="fa fa-user-circle"></i>
            </div>
            <textarea [(ngModel)]="newCommentContent[thread.id || 0]"
                      placeholder="Écrivez un commentaire..."></textarea>
          </div>
          <button (click)="addComment(thread.id || 0)" [disabled]="!newCommentContent[thread.id || 0]">
            <i class="fa fa-paper-plane"></i> Publier
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Message si aucun thread trouvé -->
  <ng-template #noThreads>
    <div class="no-threads">
      <div class="empty-state">
        <i class="fa fa-comments"></i>
        <h3>No threads found</h3>
        <p>No threads match your current filters or search criteria.</p>
        <button class="create-thread-btn" routerLink="/thread-add">
          <i class="fa fa-plus"></i> Start a new discussion
        </button>
      </div>
    </div>
  </ng-template>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button 
      class="pagination-btn" 
      [disabled]="currentPage === 1" 
      (click)="changePage(currentPage - 1)">
      <i class="fa fa-chevron-left"></i>
    </button>
    <span class="page-info">Page {{currentPage}} of {{totalPages}}</span>
    <button 
      class="pagination-btn" 
      [disabled]="currentPage === totalPages" 
      (click)="changePage(currentPage + 1)">
      <i class="fa fa-chevron-right"></i>
    </button>
  </div>
</div>