<!-- Add confetti canvas at the top -->
<canvas #confettiCanvas class="confetti-canvas"></canvas>

<div class="goal-container">
  <h2>Goals Management</h2>

  <!-- Show loading indicator -->
  <div class="loading-indicator" *ngIf="loading">
    <p>Loading...</p>
    <div class="spinner"></div>
  </div>
  
  <!-- Show error message -->
  <div class="error-message" *ngIf="error">
    <p>{{ error }}</p>
  </div>

  <!-- Warning but working message -->
  <div *ngIf="error && filteredGoals && filteredGoals.length > 0" class="warning-but-working">
    <p>Warning: {{ error }}</p>
    <p>However, some goals were still loaded and are displayed below.</p>
  </div>
  
  <!-- Button to add a new goal -->
  <div class="add-goal-container">
    <button class="add-button" (click)="showCreateForm = !showCreateForm">
      {{ showCreateForm ? 'Cancel' : 'Add New Goal' }}
    </button>
  </div>
  
  <!-- Create form - updated with required field indicators -->
  <div *ngIf="showCreateForm" class="goal-form">
    <h3>Create New Goal</h3>
    <form (ngSubmit)="createGoal()" #goalForm="ngForm">
      <div>
        <label for="description">Description: <span class="required-field">*</span></label>
        <input id="description" [(ngModel)]="newGoal.goalDescription" 
               name="description" required minlength="3" #description="ngModel"
               [class.error-field]="description.invalid && (description.dirty || description.touched || formSubmitted)">
        <div *ngIf="description.invalid && (description.dirty || description.touched || formSubmitted)" class="error">
          <div *ngIf="description.errors?.['required']">Description is required.</div>
          <div *ngIf="description.errors?.['minlength']">Description must be at least 3 characters long.</div>
        </div>
      </div>

      <div>
        <label for="targetDate">Target Date: <span class="required-field">*</span></label>
        <input id="targetDate" type="date" [(ngModel)]="newGoal.goalTargetDate" 
               name="targetDate" required #targetDate="ngModel"
               [class.error-field]="targetDate.invalid && (targetDate.dirty || targetDate.touched || formSubmitted)">
        <div *ngIf="targetDate.invalid && (targetDate.dirty || targetDate.touched || formSubmitted)" class="error">
          <div *ngIf="targetDate.errors?.['required']">Target Date is required.</div>
        </div>
      </div>

      <div>
        <label for="mentorshipProgram">Mentorship Program ID: <span class="required-field">*</span></label>
        <input id="mentorshipProgram" type="number" [(ngModel)]="newGoal.mentorshipProgramId" 
               name="mentorshipProgram" required min="1" #mentorshipProgram="ngModel"
               [class.error-field]="mentorshipProgram.invalid && (mentorshipProgram.dirty || mentorshipProgram.touched || formSubmitted)">
        <div *ngIf="mentorshipProgram.invalid && (mentorshipProgram.dirty || mentorshipProgram.touched || formSubmitted)" class="error">
          <div *ngIf="mentorshipProgram.errors?.['required']">Mentorship Program ID is required.</div>
          <div *ngIf="mentorshipProgram.errors?.['min']">Mentorship Program ID must be at least 1.</div>
        </div>
      </div>

      <!-- Add form validation summary -->
      <div *ngIf="formSubmitted && goalForm.invalid" class="form-error-summary">
        Please fill in all required fields correctly before submitting.
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-square btn-add">‚úì</button>
        <button type="button" class="btn-cancel" (click)="resetForm()">‚úñ</button>
      </div>
    </form>
  </div>

  <!-- Goal list -->
  <div class="goal-list" *ngIf="!showCreateForm && !selectedGoal">
    <div class="filters-container">
      <div class="search-filter">
        <input type="text" placeholder="Search goals..." [(ngModel)]="searchTerm" (ngModelChange)="filterGoals()" class="search-bar">
      </div>
      
      <!-- Advanced filters -->

      <div class="advanced-filters">
        <details>
          <summary>Advanced Filters</summary>
          <div class="filter-options">
            <div>
              <label>Date Range:</label>
              <div class="range-filter">
                <input type="date" [(ngModel)]="filters.dateFrom" (change)="filterGoals()">
                <span>to</span>
                <input type="date" [(ngModel)]="filters.dateTo" (change)="filterGoals()">
              </div>
            </div>
            
            <div>
              <label>Program ID:</label>
              <input type="number" [(ngModel)]="filters.programId" 
                     placeholder="Filter by program" min="1" 
                     (change)="filterGoals()">
            </div>
            
            <div class="filter-actions">
              <button class="btn-square btn-delete btn-clear-filters" (click)="clearFilters()" title="Clear Filters">üóëÔ∏è</button>
            </div>
          </div>
        </details>
      </div>
    </div>
    
    <table *ngIf="filteredGoals && filteredGoals.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Description</th>
          <th>Target Date</th>
          <th>Mentorship Program ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let goal of paginatedGoals">
          <td>{{ goal.idGoal }}</td>
          <td>{{ goal.goalDescription }}</td>
          <td>{{ goal.goalTargetDate | date:'mediumDate' }}</td>
          <td>{{ goal.mentorshipProgramId }}</td>
          <td>
            <div class="button-container">
              <button class="btn-square btn-edit" (click)="selectGoal(goal)" title="Edit">‚úèÔ∏è</button>
              <button class="btn-square btn-delete" (click)="deleteGoal(goal.idGoal)" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- Pagination controls -->
    <div class="pagination-controls" *ngIf="filteredGoals && filteredGoals.length > 0">
      <div class="pagination-info">
        Showing {{ (currentPage - 1) * pageSize + 1 }} to 
        {{ Math.min(currentPage * pageSize, filteredGoals.length) }} 
        of {{ filteredGoals.length }} goals
      </div>
      
      <div class="page-size">
        <label>Items per page:</label>
        <select [(ngModel)]="pageSize" (change)="changePageSize(pageSize)">
          <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
        </select>
      </div>
      
      <div class="page-navigation">
        <button [disabled]="currentPage === 1" (click)="prevPage()" class="btn-nav">
          &laquo; Previous
        </button>
        <span class="page-indicator">{{ currentPage }} / {{ Math.ceil(filteredGoals.length / pageSize) || 1 }}</span>
        <button [disabled]="currentPage >= Math.ceil(filteredGoals.length / pageSize)" (click)="nextPage()" class="btn-nav">
          Next &raquo;
        </button>
      </div>
    </div>
    
    <!-- No goals found message -->
    <div *ngIf="!filteredGoals || filteredGoals.length === 0" class="no-data-message">
      No goals found. Please add a new goal.
    </div>
  </div>

  <!-- Edit goal form - updated with required field indicators -->
  <div *ngIf="selectedGoal" class="goal-edit">
    <h3>Edit Goal</h3>
    <form (ngSubmit)="updateGoal()" #editGoalForm="ngForm">
      <div>
        <label for="edit-description">Description: <span class="required-field">*</span></label>
        <input id="edit-description" [(ngModel)]="selectedGoal.goalDescription" 
               name="editDescription" required minlength="3" #editDescription="ngModel"
               [class.error-field]="editDescription.invalid && (editDescription.dirty || editDescription.touched || formSubmitted)">
        <div *ngIf="editDescription.invalid && (editDescription.dirty || editDescription.touched || formSubmitted)" class="error">
          <div *ngIf="editDescription.errors?.['required']">Description is required.</div>
          <div *ngIf="editDescription.errors?.['minlength']">Description must be at least 3 characters long.</div>
        </div>
      </div>

      <div>
        <label for="edit-targetDate">Target Date: <span class="required-field">*</span></label>
        <input id="edit-targetDate" type="date" [(ngModel)]="selectedGoal.goalTargetDate" 
               name="editTargetDate" required #editTargetDate="ngModel"
               [class.error-field]="editTargetDate.invalid && (editTargetDate.dirty || editTargetDate.touched || formSubmitted)">
        <div *ngIf="editTargetDate.invalid && (editTargetDate.dirty || editTargetDate.touched || formSubmitted)" class="error">
          <div *ngIf="editTargetDate.errors?.['required']">Target Date is required.</div>
        </div>
      </div>

      <div>
        <label for="edit-mentorshipProgram">Mentorship Program ID: <span class="required-field">*</span></label>
        <input id="edit-mentorshipProgram" type="number" [(ngModel)]="selectedGoal.mentorshipProgramId" 
               name="editMentorshipProgram" required min="1" #editMentorshipProgram="ngModel"
               [class.error-field]="editMentorshipProgram.invalid && (editMentorshipProgram.dirty || editMentorshipProgram.touched || formSubmitted)">
        <div *ngIf="editMentorshipProgram.invalid && (editMentorshipProgram.dirty || editMentorshipProgram.touched || formSubmitted)" class="error">
          <div *ngIf="editMentorshipProgram.errors?.['required']">Mentorship Program ID is required.</div>
          <div *ngIf="editMentorshipProgram.errors?.['min']">Mentorship Program ID must be at least 1.</div>
        </div>
      </div>

      <!-- Add form validation summary -->
      <div *ngIf="formSubmitted && editGoalForm.invalid" class="form-error-summary">
        Please fill in all required fields correctly before submitting.
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-square btn-edit">‚úèÔ∏è</button>
        <button type="button" class="btn-cancel" (click)="clearSelection()">‚úñ</button>
      </div>
    </form>
  </div>
</div>